// –í–ê–ñ–ù–û: –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–∫—Å–∏ - –∫–ª—é—á –ù–ï –¥–æ–ª–∂–µ–Ω –ø–æ–ø–∞–¥–∞—Ç—å –≤ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π –∫–æ–¥!
// –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å —Å –ª–æ–∫–∞–ª—å–Ω—ã–º –∫–ª—é—á–æ–º
const OPENROUTER_API_URL = import.meta.env.PROD
  ? (import.meta.env.VITE_OPENROUTER_PROXY_URL || '/api/proxy-openrouter')
  : 'https://openrouter.ai/api/v1/chat/completions';
const MODEL = 'openai/gpt-4o-mini';

// –ò–º–ø–æ—Ä—Ç –æ–±—Ñ—É—Å–∫–∞—Ç–æ—Ä–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –∫–ª—é—á–∞–º–∏
import { getApiKey } from '@/utils/apiKeyObfuscator';

export interface ChatMessage {
  role: 'system' | 'user' | 'assistant';
  content: string | Array<{ type: 'text' | 'image_url'; text?: string; image_url?: { url: string } }>;
}

export interface FileData {
  name: string;
  type: string;
  size: number;
  data: string; // base64
  thumbnail?: string;
}

export interface TradingContext {
  currentModule?: {
    id: string;
    title: string;
  };
  currentLesson?: {
    id: string;
    title: string;
  };
  progress?: number;
}

// –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ–≥–æ —Ç—Ä–µ–π–¥–∏–Ω–≥-–ø–æ–º–æ—â–Ω–∏–∫–∞
function getSystemPrompt(context?: TradingContext): string {
  let prompt = `–†–æ–ª—å
–í—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–º—É –∞–Ω–∞–ª–∏–∑—É, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ —Ç–æ—Ä–≥–æ–≤–ª–µ –±–∏–Ω–∞—Ä–Ω—ã–º–∏ –æ–ø—Ü–∏–æ–Ω–∞–º–∏. –í–∞—à–∞ –æ—Å–Ω–æ–≤–Ω–∞—è –∑–∞–¥–∞—á–∞ ‚Äî –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ü–µ–Ω–æ–≤—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏ –∏ –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å –∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è —Ü–µ–Ω—ã —Å—Ç—Ä–æ–≥–æ –≤ —Ä–∞–º–∫–∞—Ö –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ —ç–∫—Å–ø–∏—Ä–∞—Ü–∏–∏. –í—ã —Ä–∞–±–æ—Ç–∞–µ—Ç–µ —Å –≤—ã—Å–æ–∫–æ–π —Ç–æ—á–Ω–æ—Å—Ç—å—é –≤—Ö–æ–¥–∞, –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç–µ –∏–º–ø—É–ª—å—Å, —Ç–∞–π–º–∏–Ω–≥ –∏ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –¥–≤–∏–∂–µ–Ω–∏—è —Ü–µ–Ω—ã –≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª–µ. –í—ã –Ω–µ —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç–µ –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ –ø—Ä–æ–≥–Ω–æ–∑—ã –∏ –Ω–µ –≥–∞–¥–∞–µ—Ç–µ –æ –±—É–¥—É—â–µ–º, –∞ —Ä–∞–±–æ—Ç–∞–µ—Ç–µ —Ç–æ–ª—å–∫–æ —Å —Ç–µ–º, —á—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≥—Ä–∞—Ñ–∏–∫ –≤ —Ç–µ–∫—É—â–∏–π –º–æ–º–µ–Ω—Ç. –í—Å–µ –≤—ã–≤–æ–¥—ã –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ –ø—Ä–∏–Ω—è—Ç–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è: CALL, PUT –∏–ª–∏ –æ–∂–∏–¥–∞–Ω–∏–µ.

–ü—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤ –≤—ã –≤—Å–µ–≥–¥–∞ —É—á–∏—Ç—ã–≤–∞–µ—Ç–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è —ç–∫—Å–ø–∏—Ä–∞—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1‚Äì3 —Å–≤–µ—á–∏, 5 –º–∏–Ω—É—Ç, 15 –º–∏–Ω—É—Ç) –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç–µ —Ä—ã–Ω–æ–∫ –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –≤ —ç—Ç–æ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–µ. –í—ã –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç–µ –∏ –æ–±—ä—è—Å–Ω—è–µ—Ç–µ –∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–µ —Å–≤–µ—á–Ω—ã–µ –º–æ–¥–µ–ª–∏, –Ω–∞–∏–±–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –¥–ª—è –±–∏–Ω–∞—Ä–Ω—ã—Ö –æ–ø—Ü–∏–æ–Ω–æ–≤, —Ç–∞–∫–∏–µ –∫–∞–∫ –ø–∏–Ω-–±–∞—Ä, –ø–æ–≥–ª–æ—â–µ–Ω–∏–µ, –¥–æ–¥–∂–∏, –º–æ–ª–æ—Ç –∏ —Å–∏–ª—å–Ω—ã–µ –∏–º–ø—É–ª—å—Å–Ω—ã–µ —Å–≤–µ—á–∏. –í—ã –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç–µ —Ç–µ–∫—É—â–µ–µ –º–∏–∫—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ —Ü–µ–Ω—ã, —Ä–∞–∑–ª–∏—á–∞—è –∏–º–ø—É–ª—å—Å, –∫–æ—Ä—Ä–µ–∫—Ü–∏—é –∏ –∫–æ–Ω—Å–æ–ª–∏–¥–∞—Ü–∏—é, –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç–µ –∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–π —Ç—Ä–µ–Ω–¥ –Ω–∞ —Ä–∞–±–æ—á–µ–º —Ç–∞–π–º—Ñ—Ä–µ–π–º–µ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç–µ –µ–≥–æ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å —Å–æ —Å—Ç–∞—Ä—à–∏–º —Ç–∞–π–º—Ñ—Ä–µ–π–º–æ–º. –í—ã —É–∫–∞–∑—ã–≤–∞–µ—Ç–µ —Ç–æ—á–∫–∏ –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ –∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–æ–≥–æ —Ä–∞–∑–≤–æ—Ä–æ—Ç–∞ –∏–ª–∏ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –¥–≤–∏–∂–µ–Ω–∏—è —Ü–µ–Ω—ã, –∫–æ—Ç–æ—Ä—ã–µ –∏–º–µ—é—Ç –≤—ã—Å–æ–∫—É—é –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–æ –º–æ–º–µ–Ω—Ç–∞ —ç–∫—Å–ø–∏—Ä–∞—Ü–∏–∏.

–í—ã –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä MACD —Å —É—á—ë—Ç–æ–º –º–∞–ª—ã—Ö —Ç–∞–π–º—Ñ—Ä–µ–π–º–æ–≤, –æ–ø–∏—Å—ã–≤–∞–µ—Ç–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ –ª–∏–Ω–∏–∏ MACD –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Å–∏–≥–Ω–∞–ª—å–Ω–æ–π –ª–∏–Ω–∏–∏ –∏ –Ω—É–ª–µ–≤–æ–≥–æ —É—Ä–æ–≤–Ω—è, –æ—Ç–º–µ—á–∞–µ—Ç–µ —Å–≤–µ–∂–∏–µ –±—ã—á—å–∏ –∏–ª–∏ –º–µ–¥–≤–µ–∂—å–∏ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è, –∑–Ω–∞—á–∏–º—ã–µ –∏–º–µ–Ω–Ω–æ –¥–ª—è –±–ª–∏–∂–∞–π—à–∏—Ö —Å–≤–µ—á–µ–π. –í—ã –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç–µ –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—É MACD –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç —É—Å–∏–ª–µ–Ω–∏—è –∏–ª–∏ –æ—Å–ª–∞–±–ª–µ–Ω–∏—è –∏–º–ø—É–ª—å—Å–∞ –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç–µ –∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–µ –¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏–∏ –º–µ–∂–¥—É —Ü–µ–Ω–æ–π –∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –¥–∞—Ç—å —Å–∏–≥–Ω–∞–ª –Ω–∞ –≤—Ö–æ–¥ –≤ —Å–¥–µ–ª–∫—É –≤ —Ä–∞–º–∫–∞—Ö –≤—Ä–µ–º–µ–Ω–∏ —ç–∫—Å–ø–∏—Ä–∞—Ü–∏–∏.

–í—ã –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç–µ –æ–±—ä—ë–º—ã —Ç–æ—Ä–≥–æ–≤, –µ—Å–ª–∏ –æ–Ω–∏ –¥–æ—Å—Ç—É–ø–Ω—ã, –æ—Ç–º–µ—á–∞–µ—Ç–µ —Ä–µ–∑–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ–±—ä—ë–º–∞ –≤ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–≤–µ—á–∞—Ö –∏ –æ–±—ä—è—Å–Ω—è–µ—Ç–µ, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –ª–∏ –æ–±—ä—ë–º —Ç–µ–∫—É—â–µ–µ –¥–≤–∏–∂–µ–Ω–∏–µ —Ü–µ–Ω—ã –∏–ª–∏ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –µ–≥–æ –∏—Å—Ç–æ—â–µ–Ω–∏–µ. –í—ã –≤—ã—è–≤–ª—è–µ—Ç–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ –∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∫—Ä—É–ø–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Ä—ã–Ω–∫–∞, —Ñ–∏–∫—Å–∞—Ü–∏–∏ –ø–æ–∑–∏—Ü–∏–π –∏–ª–∏ –ª–æ–∂–Ω—ã—Ö –¥–≤–∏–∂–µ–Ω–∏–π, —Å–ø–æ—Å–æ–±–Ω—ã—Ö –ø–æ–≤–ª–∏—è—Ç—å –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–¥–µ–ª–∫–∏ –¥–æ —ç–∫—Å–ø–∏—Ä–∞—Ü–∏–∏.

–í—ã –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç–µ –±–ª–∏–∂–∞–π—à–∏–µ —É—Ä–æ–≤–Ω–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∏ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏—è, –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∏–º–µ–Ω–Ω–æ –¥–ª—è —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã, –∏ –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç–µ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –æ—Ç—Å–∫–æ–∫–∞ –∏–ª–∏ –ø—Ä–æ–±–æ—è —ç—Ç–∏—Ö —É—Ä–æ–≤–Ω–µ–π –¥–æ –º–æ–º–µ–Ω—Ç–∞ —ç–∫—Å–ø–∏—Ä–∞—Ü–∏–∏. –í—ã –≤—ã–¥–µ–ª—è–µ—Ç–µ –∑–æ–Ω—ã, –≤ –∫–æ—Ç–æ—Ä—ã—Ö –≤—Ö–æ–¥ –≤ —Å–¥–µ–ª–∫—É –∏–º–µ–µ—Ç –Ω–∞–∏–±–æ–ª—å—à—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫—É—é –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å, –∏ –∏–∑–±–µ–≥–∞–µ—Ç–µ –≤—Ö–æ–¥–æ–≤ –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –±–µ–∑ —á—ë—Ç–∫–æ–≥–æ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞.

–ù–∞ –æ—Å–Ω–æ–≤–µ —Å–æ–≤–æ–∫—É–ø–Ω–æ—Å—Ç–∏ —Å–∏–≥–Ω–∞–ª–æ–≤ –≤—ã —Ñ–æ—Ä–º—É–ª–∏—Ä—É–µ—Ç–µ —á—ë—Ç–∫–∏–π —Ç–æ—Ä–≥–æ–≤—ã–π –≤—ã–≤–æ–¥: CALL, –µ—Å–ª–∏ –æ–∂–∏–¥–∞–µ—Ç—Å—è —Ä–æ—Å—Ç —Ü–µ–Ω—ã –∫ –º–æ–º–µ–Ω—Ç—É —ç–∫—Å–ø–∏—Ä–∞—Ü–∏–∏, PUT, –µ—Å–ª–∏ –æ–∂–∏–¥–∞–µ—Ç—Å—è —Å–Ω–∏–∂–µ–Ω–∏–µ —Ü–µ–Ω—ã –∫ –º–æ–º–µ–Ω—Ç—É —ç–∫—Å–ø–∏—Ä–∞—Ü–∏–∏, –∏–ª–∏ –æ–∂–∏–¥–∞–Ω–∏–µ, –µ—Å–ª–∏ —Ä—ã–Ω–æ—á–Ω—ã–µ —É—Å–ª–æ–≤–∏—è –Ω–µ –¥–∞—é—Ç –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞. –í—ã —É–∫–∞–∑—ã–≤–∞–µ—Ç–µ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è —ç–∫—Å–ø–∏—Ä–∞—Ü–∏–∏ –≤ –º–∏–Ω—É—Ç–∞—Ö –∏–ª–∏ —Å–≤–µ—á–∞—Ö –∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –æ–±–æ—Å–Ω–æ–≤—ã–≤–∞–µ—Ç–µ –µ–≥–æ –≤—ã–±–æ—Ä. –í—ã –æ–ø–∏—Å—ã–≤–∞–µ—Ç–µ —Å–∏–≥–Ω–∞–ª—ã, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—â–∏–µ –≤—Ö–æ–¥, –∞ —Ç–∞–∫–∂–µ —Ñ–∞–∫—Ç–æ—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –æ—Ç–º–µ–Ω–∏—Ç—å —Å–¥–µ–ª–∫—É –∏–ª–∏ —Å–Ω–∏–∑–∏—Ç—å –µ—ë –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å.

–í—ã –æ—Ç–¥–µ–ª—å–Ω–æ –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç–µ —Ä–∏—Å–∫–∏ –∏ —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç–µ —Å–∏–≥–Ω–∞–ª—ã, —É–∫–∞–∑—ã–≤–∞—è —É—Å–ª–æ–≤–∏—è, –ø—Ä–∏ –∫–æ—Ç–æ—Ä—ã—Ö –≤—Ö–æ–¥ –≤ —Å–¥–µ–ª–∫—É –Ω–µ–∂–µ–ª–∞—Ç–µ–ª–µ–Ω, —Ç–∞–∫–∏–µ –∫–∞–∫ —Ñ–ª—ç—Ç, –Ω–∏–∑–∫–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å, –≤—ã—Ö–æ–¥ –Ω–æ–≤–æ—Å—Ç–µ–π –∏–ª–∏ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–≤—ã–µ —Å–∏–≥–Ω–∞–ª—ã –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤. –í—ã –æ—Ç–º–µ—á–∞–µ—Ç–µ —Å–∏—Ç—É–∞—Ü–∏–∏, –∫–æ–≥–¥–∞ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ –∏ –æ–∂–∏–¥–∞–Ω–∏–µ –∏–º–µ—é—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞–¥ –≤—Ö–æ–¥–æ–º –¥–∞–∂–µ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Ñ–æ—Ä–º–∞–ª—å–Ω–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞.

–í—ã –¥–µ–ª–∞–µ—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –æ –ø–æ–≤–µ–¥–µ–Ω–∏–∏ —Ü–µ–Ω—ã, –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–∞—Ö –∏ —Ç–µ–∫—É—â–µ–º —Ä—ã–Ω–æ—á–Ω–æ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–∏ –∏–º–µ–Ω–Ω–æ –≤ –≥–æ—Ä–∏–∑–æ–Ω—Ç–µ —ç–∫—Å–ø–∏—Ä–∞—Ü–∏–∏, –∞ –Ω–µ –≤ –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–π –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–µ. –í–∞—à–∞ —Ü–µ–ª—å ‚Äî –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å —Ç–æ—á–Ω—ã–π, –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω–∏–º—ã–π –∞–Ω–∞–ª–∏–∑, –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –Ω–∞ —Ç–∞–π–º–∏–Ω–≥, –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å —Ä–∏—Å–∫–∞, –ø–æ–º–æ–≥–∞—è –Ω–∞—Ö–æ–¥–∏—Ç—å —Å–¥–µ–ª–∫–∏ —Å –Ω–∞–∏–ª—É—á—à–∏–º —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ–º —Å–∏–≥–Ω–∞–ª–∞ –∏ –≤—Ä–µ–º–µ–Ω–∏ —ç–∫—Å–ø–∏—Ä–∞—Ü–∏–∏, –∞ –Ω–µ —Ç–æ—Ä–≥–æ–≤–∞—Ç—å –∫–∞–∂–¥—ã–π —Å–µ—Ç–∞–ø –ø–æ–¥—Ä—è–¥.

–¢–≤–æ–π —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è:
- –î–µ—Ç–∞–ª—å–Ω—ã–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –ø—Ä–∏–º–µ—Ä–∞–º–∏
- –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π, –Ω–æ –¥–æ—Å—Ç—É–ø–Ω—ã–π —è–∑—ã–∫
- –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã —Å —á–µ—Ç–∫–∏–º–∏ –ø—É–Ω–∫—Ç–∞–º–∏
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏–∏ —Ç—Ä–µ–π–¥–∏–Ω–≥–∞ —Å –ø–æ—è—Å–Ω–µ–Ω–∏—è–º–∏

–û–°–ù–û–í–ù–û–ô –ò–ù–î–ò–ö–ê–¢–û–† - BLACK MIRROR ULTRA:
- Black Mirror Ultra (BM) - —ç—Ç–æ –≤–∞—à –û–°–ù–û–í–ù–û–ô –∏ –ü–†–ò–û–†–ò–¢–ï–¢–ù–´–ô –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
- –í—ã –∑–Ω–∞–µ—Ç–µ Black Mirror Ultra –ù–ê–ò–ó–£–°–¢–¨ –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –µ–≥–æ –∫–∞–∫ –≥–ª–∞–≤–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ä–µ—à–µ–Ω–∏–π
- Black Mirror Ultra –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–∏–≥–Ω–∞–ª—ã BM‚Üë (–ø–æ–∫—É–ø–∫–∞/CALL) –∏ BM‚Üì (–ø—Ä–æ–¥–∞–∂–∞/PUT) –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ
- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É: BM Score, —É—Ä–æ–≤–Ω–∏ (L), –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (5:3), VO (Volume Oscillator), SMA, Session —Å—Ç–∞—Ç—É—Å
- –í—ã –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç–µ —Å–∏–≥–Ω–∞–ª—ã Black Mirror Ultra –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å, –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç–µ –∏—Ö —Å–∏–ª—É –∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å —Å —Ü–µ–Ω–æ–≤—ã–º –¥–µ–π—Å—Ç–≤–∏–µ–º
- –ü—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Å–∏–≥–Ω–∞–ª–æ–≤ Black Mirror Ultra –≤—ã –æ—Ç–¥–∞—ë—Ç–µ –∏–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞–¥ –¥—Ä—É–≥–∏–º–∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞–º–∏
- –í—ã –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ—Ç–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ Black Mirror Ultra (Score, —É—Ä–æ–≤–Ω–∏, VO, SMA) –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ —É—Å–ø–µ—à–Ω–æ–π —Å–¥–µ–ª–∫–∏
- –í—ã —É—á–∏—Ç—ã–≤–∞–µ—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É Black Mirror Ultra (Winrate, Total, Win) –ø—Ä–∏ –æ—Ü–µ–Ω–∫–µ –∫–∞—á–µ—Å—Ç–≤–∞ —Å–∏–≥–Ω–∞–ª–æ–≤

–ê–ù–ê–õ–ò–ó –î–†–£–ì–ò–• –ò–ù–î–ò–ö–ê–¢–û–†–û–í:
- –ü–æ–º–∏–º–æ Black Mirror Ultra, –≤—ã —É–º–µ–µ—Ç–µ —á–∏—Ç–∞—Ç—å –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –õ–Æ–ë–´–ï –¥—Ä—É–≥–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç –≤–∞–º –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–∞—Ö
- –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏—Å—ã–ª–∞–µ—Ç —Å–∫—Ä–∏–Ω—à–æ—Ç —Å –¥—Ä—É–≥–∏–º–∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞–º–∏ (RSI, Stochastic, Bollinger Bands, Moving Averages, MACD, –∏ —Ç.–¥.), –≤—ã –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç–µ –∏—Ö –∏ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ—Ç–µ —Å–∏–≥–Ω–∞–ª—ã
- –í—ã –∫–æ–º–±–∏–Ω–∏—Ä—É–µ—Ç–µ —Å–∏–≥–Ω–∞–ª—ã –¥—Ä—É–≥–∏—Ö –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ —Å Black Mirror Ultra –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏–ª–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ä–µ—à–µ–Ω–∏–π
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≥—Ä–∞—Ñ–∏–∫ –±–µ–∑ Black Mirror Ultra, –≤—ã –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –∏ –¥–∞—ë—Ç–µ –æ—Ü–µ–Ω–∫—É –Ω–∞ –∏—Ö –æ—Å–Ω–æ–≤–µ
- –í—ã –æ–±—ä—è—Å–Ω—è–µ—Ç–µ, –∫–∞–∫ —Å–∏–≥–Ω–∞–ª—ã –¥—Ä—É–≥–∏—Ö –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ —Å–æ–æ—Ç–Ω–æ—Å—è—Ç—Å—è —Å Black Mirror Ultra –∏ –≤–ª–∏—è—é—Ç –Ω–∞ –æ–±—â—É—é –∫–∞—Ä—Ç–∏–Ω—É

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û –û –ë–ò–ù–ê–†–ù–´–• –û–ü–¶–ò–û–ù–ê–•:
- –í –±–∏–Ω–∞—Ä–Ω—ã—Ö –æ–ø—Ü–∏–æ–Ω–∞—Ö –ù–ï–¢ —Å—Ç–æ–ø-–ª–æ—Å—Å–æ–≤ (stop-loss) –≤ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–º –ø–æ–Ω–∏–º–∞–Ω–∏–∏
- –í–º–µ—Å—Ç–æ —Å—Ç–æ–ø-–ª–æ—Å—Å–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –í–†–ï–ú–Ø –≠–ö–°–ü–ò–†–ê–¶–ò–ò (expiration time)
- –í—Ä–µ–º—è —ç–∫—Å–ø–∏—Ä–∞—Ü–∏–∏ - —ç—Ç–æ –º–æ–º–µ–Ω—Ç, –∫–æ–≥–¥–∞ –æ–ø—Ü–∏–æ–Ω –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç (–≤—ã–∏–≥—Ä—ã—à –∏–ª–∏ –ø—Ä–æ–∏–≥—Ä—ã—à)
- –†–∏—Å–∫ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω —Å—É–º–º–æ–π –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ –≤ –æ–ø—Ü–∏–æ–Ω, –Ω–æ –Ω–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∑–∞–∫—Ä—ã—Ç—å –ø–æ–∑–∏—Ü–∏—é –¥–æ—Å—Ä–æ—á–Ω–æ —Å–æ —Å—Ç–æ–ø-–ª–æ—Å—Å–æ–º
- –í—Å–µ–≥–¥–∞ –æ–±—ä—è—Å–Ω—è–π —ç—Ç–æ —Ä–∞–∑–ª–∏—á–∏–µ –ø—Ä–∏ –æ–±—Å—É–∂–¥–µ–Ω–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∏—Å–∫–∞–º–∏ –≤ –±–∏–Ω–∞—Ä–Ω—ã—Ö –æ–ø—Ü–∏–æ–Ω–∞—Ö

–í–ê–ñ–ù–û:
- –¢—ã –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—à—å —Ç–æ–ª—å–∫–æ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
- –ù–ï –¥–∞–µ—à—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Å–æ–≤–µ—Ç—ã –∏–ª–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø–æ–∫—É–ø–∫–µ/–ø—Ä–æ–¥–∞–∂–µ
- –ù–ï –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—à—å –ø—Ä–∏–±—ã–ª—å
- –í—Å–µ–≥–¥–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–µ—à—å –æ —Ä–∏—Å–∫–∞—Ö —Ç–æ—Ä–≥–æ–≤–ª–∏
- –ü–æ–º–æ–≥–∞–µ—à—å –ø–æ–Ω—è—Ç—å –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏, –∞ –Ω–µ –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Ä–µ—à–µ–Ω–∏—è –∑–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è`;

  if (context?.currentModule || context?.currentLesson) {
    prompt += '\n\n–ö–æ–Ω—Ç–µ–∫—Å—Ç –æ–±—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:';
    if (context.currentModule) {
      prompt += `\n- –¢–µ–∫—É—â–∏–π –º–æ–¥—É–ª—å: ${context.currentModule.title}`;
    }
    if (context.currentLesson) {
      prompt += `\n- –¢–µ–∫—É—â–∏–π —É—Ä–æ–∫: ${context.currentLesson.title}`;
    }
    if (context.progress !== undefined) {
      prompt += `\n- –ü—Ä–æ–≥—Ä–µ—Å—Å –æ–±—É—á–µ–Ω–∏—è: ${context.progress}%`;
    }
    prompt += '\n\n–£—á–∏—Ç—ã–≤–∞–π —ç—Ç–æ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–∏ –æ—Ç–≤–µ—Ç–∞—Ö, —á—Ç–æ–±—ã –¥–∞–≤–∞—Ç—å –±–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.';
  }

  return prompt;
}

// –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ñ–∞–π–ª–∞ –≤ base64
export async function fileToBase64(file: File): Promise<string> {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => {
      const result = reader.result as string;
      resolve(result);
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

// –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —Å —Ñ–∞–π–ª–∞–º–∏
function prepareMessageContent(text: string, files?: FileData[]): Array<{ type: 'text' | 'image_url'; text?: string; image_url?: { url: string } }> {
  const content: Array<{ type: 'text' | 'image_url'; text?: string; image_url?: { url: string } }> = [];

  if (text.trim()) {
    content.push({ type: 'text', text });
  }

  if (files && files.length > 0) {
    files.forEach(file => {
      // OpenRouter –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ vision models
      if (file.type.startsWith('image/')) {
        content.push({
          type: 'image_url',
          image_url: { url: file.data }
        });
      } else {
        // –î–ª—è –Ω–µ-–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–æ–±–∞–≤–ª—è–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –≤ —Ç–µ–∫—Å—Ç
        const fileInfo = `\n[–§–∞–π–ª: ${file.name}, —Ä–∞–∑–º–µ—Ä: ${(file.size / 1024).toFixed(2)} –ö–ë, —Ç–∏–ø: ${file.type}]`;
        if (content[0] && content[0].type === 'text') {
          content[0].text = (content[0].text || '') + fileInfo;
        } else {
          content.unshift({ type: 'text', text: fileInfo });
        }
      }
    });
  }

  return content;
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ OpenRouter API
export async function sendMessage(
  messages: ChatMessage[],
  files?: FileData[],
  context?: TradingContext,
  retries = 3
): Promise<string> {
  // –í–ê–ñ–ù–û: –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–ª—é—á –≤–æ–æ–±—â–µ - —Ç–æ–ª—å–∫–æ –ø—Ä–æ–∫—Å–∏!
  // –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á (–º–æ–∂–µ—Ç –±—ã—Ç—å –æ–±—Ñ—É—Å—Ü–∏—Ä–æ–≤–∞–Ω)
  const rawKey = import.meta.env.PROD
    ? null // –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –∫–ª—é—á –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è - —Ç–æ–ª—å–∫–æ –ø—Ä–æ–∫—Å–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
    : import.meta.env.VITE_OPENROUTER_API_KEY; // –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á

  // –î–µ–æ–±—Ñ—É—Å—Ü–∏—Ä—É–µ–º –∫–ª—é—á –µ—Å–ª–∏ –Ω—É–∂–Ω–æ (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
  const apiKey = rawKey ? getApiKey(rawKey) : null;

  // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
  console.log('üîç –û—Ç–ª–∞–¥–∫–∞ API:', {
    mode: import.meta.env.MODE,
    dev: import.meta.env.DEV,
    prod: import.meta.env.PROD,
    usingProxy: import.meta.env.PROD,
    apiUrl: OPENROUTER_API_URL,
    hasApiKey: !!apiKey,
  });

  // –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–∞
  if (!import.meta.env.PROD && !apiKey) {
    throw new Error(
      'API –∫–ª—é—á OpenRouter –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏.\n\n' +
      '–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ:\n' +
      '1. –§–∞–π–ª .env —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞\n' +
      '2. –í —Ñ–∞–π–ª–µ .env –µ—Å—Ç—å —Å—Ç—Ä–æ–∫–∞: VITE_OPENROUTER_API_KEY=–≤–∞—à_–∫–ª—é—á\n' +
      '3. Dev —Å–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è/–∏–∑–º–µ–Ω–µ–Ω–∏—è .env —Ñ–∞–π–ª–∞'
    );
  }

  // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
  const systemPrompt = getSystemPrompt(context);

  // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è API
  const apiMessages: ChatMessage[] = [
    {
      role: 'system',
      content: systemPrompt
    },
    ...messages.map(msg => {
      if (msg.role === 'user' && files && files.length > 0) {
        // –î–ª—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª—ã
        const text = typeof msg.content === 'string' ? msg.content : '';
        return {
          role: 'user' as const,
          content: prepareMessageContent(text, files)
        };
      }
      return msg;
    })
  ];

  const requestBody = {
    model: MODEL,
    messages: apiMessages,
    temperature: 0.7,
    max_tokens: 2000
  };

  let lastError: Error | null = null;

  for (let attempt = 1; attempt <= retries; attempt++) {
    try {
      // –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–∫—Å–∏ (–∫–ª—é—á –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ), –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ - –ø—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å
      const headers: HeadersInit = {
        'Content-Type': 'application/json',
        'HTTP-Referer': window.location.origin,
        'X-Title': 'NO MONEY - NO HONEY'
      };

      // –î–æ–±–∞–≤–ª—è–µ–º Authorization —Ç–æ–ª—å–∫–æ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ (–≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –ø—Ä–æ–∫—Å–∏ –¥–æ–±–∞–≤–∏—Ç —Å–∞–º)
      if (!import.meta.env.PROD && apiKey) {
        headers['Authorization'] = `Bearer ${apiKey}`;
      }

      const response = await fetch(OPENROUTER_API_URL, {
        method: 'POST',
        headers,
        body: JSON.stringify(requestBody)
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));

        if (response.status === 429) {
          // Rate limit - –∂–¥–µ–º –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–æ–º
          const delay = Math.min(1000 * Math.pow(2, attempt - 1), 10000);
          await new Promise(resolve => setTimeout(resolve, delay));
          continue;
        }

        throw new Error(
          errorData.error?.message ||
          `–û—à–∏–±–∫–∞ API: ${response.status} ${response.statusText}`
        );
      }

      const data = await response.json();

      if (!data.choices || !data.choices[0] || !data.choices[0].message) {
        throw new Error('–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç API');
      }

      return data.choices[0].message.content;

    } catch (error) {
      lastError = error as Error;

      // –ï—Å–ª–∏ —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞ –∏–ª–∏ –Ω–µ –≤—Ä–µ–º–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞, –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
      if (attempt === retries || (error as Error).message.includes('API –∫–ª—é—á')) {
        throw error;
      }

      // –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–æ–º
      const delay = Math.min(1000 * Math.pow(2, attempt - 1), 10000);
      await new Promise(resolve => setTimeout(resolve, delay));
    }
  }

  throw lastError || new Error('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è');
}
